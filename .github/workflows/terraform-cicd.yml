name: Terraform CI/CD

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action (plan/apply/destroy/deploy-k8s)'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
          - deploy-k8s
      confirm:
        description: '–í–≤–µ–¥–∏—Ç–µ ¬´yes¬ª –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è apply/destroy/deploy-k8s)'
        required: false
        default: 'no'

jobs:
  terraform:
    name: 'Terraform –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞'
    runs-on: ubuntu-latest
    environment: production
    env:
      TF_VAR_token: ${{ secrets.YC_TOKEN }}
      TF_VAR_cloud_id: ${{ secrets.YC_CLOUD_ID }}
      TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
      TF_VAR_s3_access_key: ${{ secrets.YC_S3_ACCESS_KEY }}
      TF_VAR_s3_secret_key: ${{ secrets.YC_S3_SECRET_KEY }}
      TF_VAR_s3_bucket_name: ${{ secrets.YC_S3_BUCKET_NAME }}
      TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

    steps:
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.5"

      - name: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Terraform
        run: |
          terraform init \
            -backend-config="endpoint=https://storage.yandexcloud.net" \
            -backend-config="bucket=${{ secrets.YC_S3_BUCKET_NAME }}" \
            -backend-config="region=ru-central1" \
            -backend-config="access_key=${{ secrets.YC_S3_ACCESS_KEY }}" \
            -backend-config="secret_key=${{ secrets.YC_S3_SECRET_KEY }}"

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏
        run: terraform fmt -check -recursive  # –î–æ–±–∞–≤–ª–µ–Ω -recursive –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤

      - name: –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        run: terraform validate

      - name: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if: github.event.inputs.action == 'plan' || (github.event.inputs.action == 'apply' && github.event.inputs.confirm == 'yes')
        run: terraform plan -out=tfplan

      - name: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if: github.event.inputs.action == 'apply' && github.event.inputs.confirm == 'yes'
        run: terraform apply -auto-approve tfplan

      - name: –ü–ª–∞–Ω —É–¥–∞–ª–µ–Ω–∏—è
        if: github.event.inputs.action == 'destroy' && github.event.inputs.confirm == 'yes'
        run: terraform plan -destroy -out=tfdestroy

      - name: –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        if: github.event.inputs.action == 'destroy' && github.event.inputs.confirm == 'yes'
        run: terraform apply -auto-approve tfdestroy

      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ inventory-—Ñ–∞–π–ª–∞ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
        if: success() && (github.event.inputs.action == 'apply' || github.event.inputs.action == 'deploy-k8s')
        uses: actions/upload-artifact@v4
        with:
          name: kubespray-inventory
          path: kubespray/inventory/hosts.yaml
          retention-days: 1  # –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ —É–º–µ–Ω—å—à–∏–ª –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          if-no-files-found: error  # –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ñ–∞–π–ª–∞
      - name: üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kubernetes —á–µ—Ä–µ–∑ Kubespray
        if: github.event.inputs.action == 'deploy-k8s' && github.event.inputs.confirm == 'yes'
        run: |
          echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
          sudo apt update && sudo apt install -y python3-pip sshpass git
          pip3 install ansible

          echo "–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Kubespray"
          git clone https://github.com/kubernetes-sigs/kubespray.git 
          cd kubespray
          pip3 install -r requirements.txt

          echo "–ó–∞–≥—Ä—É–∑–∫–∞ inventory –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞"
          cp ../kubespray/inventory/hosts.yaml inventory/

          echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–∞"
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "–¢–µ—Å—Ç SSH-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ –≤—Å–µ–º —Ö–æ—Å—Ç–∞–º"
          for host in $(grep -E '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' inventory/hosts.yaml | awk '{print $1}'); do
            echo "üîå –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ $host"
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$host "echo OK" || exit 1
          done

          echo "–ó–∞–ø—É—Å–∫ Kubespray Playbook"
          ansible-playbook -i inventory/hosts.yaml cluster.yml --private-key=~/.ssh/id_rsa -u ubuntu

          echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kubernetes –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"